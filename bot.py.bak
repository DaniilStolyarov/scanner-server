# scanner_bot.py  â€“ python-telegram-bot 22  +  websockets 11
import os, asyncio, pathlib, logging, io
from datetime import datetime, timezone, timedelta
import websockets
from telegram import (
    Update, ReplyKeyboardMarkup, KeyboardButton,
    BotCommand, InputFile
)
from telegram.ext import (
    Application, ContextTypes, CommandHandler,
    MessageHandler, filters
)

# â”€â”€â”€ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOKEN      = os.getenv("SCANNER_BOT_TOKEN")
WS_HOST    = "0.0.0.0"
WS_PORT    = 8765
IMAGES_DIR = pathlib.Path("scans/images")
TIMEOUT    = 15
MSK        = timezone(timedelta(hours=3))

# â”€â”€â”€ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logging.basicConfig(level=logging.INFO,
                    format="%(asctime)s [%(levelname)s] %(name)s: %(message)s")
logging.getLogger("telegram.ext").setLevel(logging.DEBUG)
log = logging.getLogger("scanner")

# â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ws_client: websockets.WebSocketServerProtocol | None = None
img_queue: asyncio.Queue[bytes] = asyncio.Queue()

async def ws_handler(ws: websockets.WebSocketServerProtocol):
    global ws_client
    ws_client = ws
    log.info("Flutter Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½")
    try:
        async for msg in ws:
            if isinstance(msg, bytes):
                await img_queue.put(msg)
            else:
                log.debug("WS text: %s", msg)
    finally:
        if ws_client is ws:
            ws_client = None
            log.info("Flutter Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ñ‘Ğ½")

async def send_scan_cmd():
    """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ {'cmd':'scan'} Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ, ĞµÑĞ»Ğ¸ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ¶Ğ¸Ğ²Ğ¾."""
    global ws_client
    if not ws_client:                       # ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½
        log.warning("ĞĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° WebSocket")
        return
    try:
        await ws_client.send('{"cmd":"scan"}')
        log.info("SCAN cmd sent to WS")
    except Exception as e:                  # ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¾ Ğ¸Ğ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
        log.warning("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ WS-ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ: %s", e)
        ws_client = None                    # Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚


# â”€â”€â”€ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def make_fname() -> str:
    return f"{int(datetime.now(MSK).timestamp() * 1000)}.png"

def ensure_dirs():
    IMAGES_DIR.mkdir(parents=True, exist_ok=True)

# â”€â”€â”€ Telegram-Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def cmd_start(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    kb = ReplyKeyboardMarkup([[KeyboardButton("ğŸ“· Ğ¡ĞºĞ°Ğ½")]], resize_keyboard=True)
    await update.message.reply_text(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ĞĞ°Ğ¶Ğ¼Ğ¸ Â«ğŸ“· Ğ¡ĞºĞ°Ğ½Â» Ğ¸Ğ»Ğ¸ /scan, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ ÑĞ½Ğ¸Ğ¼Ğ¾Ğº.",
        reply_markup=kb
    )

async def do_scan(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    log.info("SCAN requested by chat %s", update.effective_chat.id)
    note = await update.message.reply_text(f"ğŸ“¸ ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»â€¦ (â‰¤ {TIMEOUT}s)")
    await send_scan_cmd()

    try:
        img_bytes = await asyncio.wait_for(img_queue.get(), timeout=TIMEOUT)
    except asyncio.TimeoutError:
        await note.edit_text("âš ï¸ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ½Ğµ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¾. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.")
        return

    fname = make_fname()
    ensure_dirs()
    (IMAGES_DIR / fname).write_bytes(img_bytes)

    await ctx.bot.send_photo(
        chat_id=update.effective_chat.id,
        photo=InputFile(io.BytesIO(img_bytes), filename=fname),
        caption=f"Ğ¡ĞºĞ°Ğ½ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½: `{fname}`",
        parse_mode="Markdown"
    )
    await note.delete()

async def unknown(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°.")

# â”€â”€â”€ Ğ·Ğ°Ğ¿ÑƒÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    if not TOKEN:
        raise RuntimeError("SCANNER_BOT_TOKEN Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½")

    ensure_dirs()

    ws_srv = await websockets.serve(ws_handler, WS_HOST, WS_PORT)
    log.info("WS listening on ws://%s:%d", WS_HOST, WS_PORT)

    app = Application.builder().token(TOKEN).build()
    await app.bot.set_my_commands([BotCommand("scan", "ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾")])

    app.add_handler(CommandHandler("start", cmd_start))
    app.add_handler(CommandHandler("scan", do_scan))
    app.add_handler(MessageHandler(filters.TEXT & filters.Regex(r"(?i)ÑĞºĞ°Ğ½"), do_scan))
    app.add_handler(MessageHandler(filters.COMMAND, unknown))

    await app.initialize()
    await app.start()
    await app.updater.start_polling()      # â† Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ await
    log.info("Bot pollingâ€¦ (Ctrl-C Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸)")

    try:
        await asyncio.Event().wait()       # Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ¶Ğ¸Ğ²Ñ‹Ğ¼
    finally:
        await app.updater.stop()
        await app.stop()
        await app.shutdown()
        ws_srv.close()
        await ws_srv.wait_closed()

if __name__ == "__main__":
    asyncio.run(main())
